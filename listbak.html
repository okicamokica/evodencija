<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3004/3004451.png">
    
    <title>Zdravstveni Dnevnik v22</title>
    
    <link rel="manifest" href='data:application/manifest+json,{"name":"Dnevnik Zdravlja","short_name":"Zdravlje","start_url":".","display":"standalone","background_color":"#f0f2f5","theme_color":"#2563eb","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/3004/3004451.png","sizes":"512x512","type":"image/png"}]}'>

    <style>
        :root { --bg: #f0f2f5; --card: #ffffff; --primary: #2563eb; --success: #059669; --danger: #ef4444; --secondary: #64748b; --brown: #78350f; --note: #fef3c7; --state: #6366f1; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 0; color: #1f2937; -webkit-tap-highlight-color: transparent; }
        
        /* Gumb za instalaciju */
        #install-row { display: none; background: #1e293b; color: white; padding: 10px; text-align: center; font-size: 0.9em; }
        #install-btn { background: var(--success); color: white; border: none; padding: 8px 15px; border-radius: 8px; font-weight: bold; margin-left: 10px; cursor: pointer; }

        .tab-bar { display: flex; background: var(--card); position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; font-weight: bold; color: var(--secondary); cursor: pointer; border-bottom: 3px solid transparent; font-size: 0.9em; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; padding: 10px; }
        .tab-content.active { display: block; }
        .container { max-width: 600px; margin: auto; padding-bottom: 50px; }
        .card { background: var(--card); padding: 16px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 12px; }
        h3 { margin: 0 0 12px 0; font-size: 1.1em; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .entry-item { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; margin-bottom: 10px; }
        .item-top { display: flex; align-items: center; justify-content: space-between; }
        .item-label { display: flex; align-items: center; gap: 12px; font-size: 1em; flex-grow: 1; font-weight: 500; }
        input[type="checkbox"] { width: 26px; height: 26px; cursor: pointer; }
        .details-selector { display: none; margin-top: 10px; }
        .details-selector.visible { display: block; }
        .meal-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .meal-opt { font-size: 0.75em; padding: 10px 2px; border: 1px solid #d1d5db; border-radius: 8px; text-align: center; background: white; font-weight: 600; cursor: pointer; }
        .meal-opt.selected { background: var(--success); color: white; border-color: var(--success); }
        .flex-row { display: flex; gap: 10px; margin-bottom: 10px; }
        label { display: block; font-weight: 600; font-size: 0.85em; margin-bottom: 4px; color: #4b5563; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; box-sizing: border-box; font-size: 16px; font-family: inherit; }
        textarea { resize: vertical; min-height: 80px; }
        .btn-main { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 1.1em; transition: opacity 0.2s; }
        .btn-main:active { opacity: 0.7; }
        .btn-save { background: var(--primary); color: white; margin-top: 10px; }
        .btn-add-inline { padding: 10px; background: #e2e8f0; border: 1px dashed var(--secondary); border-radius: 8px; font-size: 0.85em; cursor: pointer; width: auto; }
        .day-group { margin-bottom: 25px; border-left: 4px solid var(--primary); padding-left: 10px; }
        .day-header { font-weight: bold; font-size: 1.1em; background: #e2e8f0; padding: 6px 12px; border-radius: 6px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .meal-row { background: white; padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e2e8f0; }
        .meal-title { font-weight: bold; text-transform: uppercase; font-size: 0.75em; margin-bottom: 6px; display: block; }
        .param-badge { background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-size: 0.85em; margin-right: 4px; display: inline-block; margin-top: 2px; border: 1px solid #e2e8f0; }
        .delete-btn { color: var(--danger); font-size: 0.8em; cursor: pointer; float: right; margin-left: 10px; }
        .remove-item-btn { color: var(--danger); font-weight: bold; padding: 5px 10px; cursor: pointer; font-size: 1.2em; border: none; background: transparent; }
        .note-box { background: var(--note); border-left: 4px solid #f59e0b; padding: 8px; margin-top: 8px; border-radius: 4px; font-style: italic; font-size: 0.9em; }
        #search-input { border: 2px solid var(--primary); background: #fff; position: sticky; top: 55px; z-index: 999; margin-bottom: 15px; }

        @media print {
            .tab-bar, .btn-main, .remove-item-btn, .delete-btn, .btn-save, .btn-add-inline, #search-input, #install-row { display: none !important; }
            body { background: white; }
            .card { box-shadow: none; border: 1px solid #eee; }
            .tab-content { display: block !important; }
            #unos-tab, #pdf-tab { display: none !important; }
        }
    </style>
</head>
<body>

<div id="install-row">
    Instaliraj aplikaciju za br≈æi pristup! 
    <button id="install-btn">INSTALIRAJ</button>
</div>

<div class="tab-bar">
    <button class="tab-btn active" onclick="openTab('unos-tab', this)">‚ûï UNOS</button>
    <button class="tab-btn" onclick="openTab('pregled-tab', this); renderGroupedHistory();">üìã PREGLED</button>
    <button class="tab-btn" onclick="openTab('pdf-tab', this)">‚öôÔ∏è POSTAVKE</button>
</div>

<div class="container">
    <div id="unos-tab" class="tab-content active">
        <div class="card">
            <div class="flex-row">
                <div style="flex:1.5"><label>üìÖ Datum</label><input type="date" id="datum_zapisa"></div>
                <div style="flex:1"><label>üïí Vrijeme</label><input type="time" id="vrijeme_zapisa"></div>
            </div>
        </div>

        <div class="card" style="border-left: 5px solid var(--brown);">
            <h3 style="color: var(--brown);">Probava</h3>
            <select id="stolica_stanje">
                <option value="">-- Odaberi --</option>
                <option value="Nema stolice">‚ùå Nema stolice</option>
                <option value="Normalna üí©">Normalna üí©</option>
                <option value="Mekana üí©">Mekana üí©</option>
                <option value="Proljev üí©">Proljev üí©</option>
                <option value="Tvrda üí©">Tvrda üí©</option>
                <option value="Sluzava üí©">Sluzava üí©</option>
                <option value="Krvava üí©">Krvava üí©</option>
                <option value="Svijetla üí©">Svijetla üí©</option>
                <option value="Vjetrovi">üí® Samo vjetrovi</option>
            </select>
            <button class="btn-main btn-save" style="background: var(--brown);" onclick="saveEntry()">SPREMI PROBAVU</button>
        </div>

        <div class="card">
            <h3>üçé Hrana</h3>
            <div id="hrana_popis"></div>
            <div class="flex-row"><input type="text" id="novo_hrana" placeholder="Nova namirnica..."><button class="btn-add-inline" onclick="addItem('hrana')">+ Dodaj</button></div>
        </div>

        <div class="card">
            <h3>üíä Lijekovi</h3>
            <div id="lijekovi_popis"></div>
            <div class="flex-row"><input type="text" id="novo_lijek" placeholder="Novi lijek..."><button class="btn-add-inline" onclick="addItem('lijek')">+ Dodaj</button></div>
        </div>

        <div class="card" style="border-left: 5px solid var(--state);">
            <h3 style="color: var(--state);">Stanje</h3>
            <div class="flex-row">
                <div style="flex:1"><label>Tlak</label><input type="text" id="tlak" placeholder="120/80"></div>
                <div style="flex:1"><label>Temp ¬∞C</label><input type="number" step="0.1" id="temp"></div>
            </div>
            <div class="flex-row">
                <div style="flex:1"><label>‚ö° Bol</label><select id="bol_tip"><option value="">Nema</option><option>Slabi grƒçevi</option><option>Jaki grƒçevi</option><option>Probadanje</option><option>Tupa bol</option></select></div>
                <div style="flex:1"><label>‚ö†Ô∏è Alergija</label><select id="alergija_tip"><option value="">Nema</option><option>Osip</option><option>Svrbe≈æ</option><option>Crvenilo</option></select></div>
            </div>
        </div>

        <div class="card">
            <h3>üìù Napomena</h3>
            <textarea id="napomena" placeholder="Dodatne informacije..."></textarea>
            <button class="btn-main btn-save" onclick="saveEntry()">SPREMI KOMPLETAN ZAPIS ‚úÖ</button>
        </div>
    </div>

    <div id="pregled-tab" class="tab-content">
        <input type="text" id="search-input" placeholder="üîç Pretra≈æi sve (npr. 'nema stolice', 'piletina', 'tlak'...)" onkeyup="renderGroupedHistory()">
        <div id="grouped-history"></div>
        <button class="btn-main" style="background:#10b981; color:white; margin-top:20px;" onclick="exportToCSV()">IZVEZI CSV üì•</button>
    </div>

    <div id="pdf-tab" class="tab-content">
        <div class="card"><h3>üìÑ Izvje≈°taj</h3><button class="btn-main" style="background:var(--danger); color:white;" onclick="window.print()">GENERIRAJ PDF üñ®Ô∏è</button></div>
        <div class="card"><h3>üì• Uvoz CSV</h3><input type="file" id="csv-file" accept=".csv" style="margin-bottom:10px;"><button class="btn-main" style="background:var(--secondary); color:white;" onclick="importCSV()">UVEZI PODATKE üì§</button></div>
    </div>
</div>

<script>
    // --- PWA SERVICE WORKER REGISTRACIJA ---
    if ('serviceWorker' in navigator) {
        const swCode = `
            const CACHE_NAME = 'zdravlje-v22';
            self.addEventListener('install', e => {
                e.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(['./'])));
            });
            self.addEventListener('fetch', e => {
                e.respondWith(caches.match(e.request).then(res => res || fetch(e.request)));
            });
        `;
        const blob = new Blob([swCode], { type: 'application/javascript' });
        navigator.serviceWorker.register(URL.createObjectURL(blob));
    }

    // Instalacijski gumb logika
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('install-row').style.display = 'block';
    });

    document.getElementById('install-btn').addEventListener('click', () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then(() => {
                document.getElementById('install-row').style.display = 'none';
                deferredPrompt = null;
            });
        }
    });

    // --- LOGIKA APLIKACIJE ---
    const mealNames = ["Doruƒçak", "Marenda", "Ruƒçak", "U≈æina", "Veƒçera"];
    const defaultHrana = ["Kuhana puretina", "Kuhana jabuka", "Juha od buƒáe i krompira", "Juha juneƒáa/teleƒáa", "Kuhana teletina", "Kuhana junetina", "Dvopek", "Tost", "Kuhana ri≈æa", "Pire krumpir", "Kuhana mrkva", "Kuhana tikvica", "Kuhana piletina", "Kuhana riba (osliƒá)", "Banana", "Jogurt", "Griz na vodi"];
    const defaultLijekovi = ["OLEOVIT D3", "LETIZEN", "≈ΩELJEZO", "MODULEN", "COLESTYRAMIN", "Vivomix"];

    let customHrana = JSON.parse(localStorage.getItem('cH_v14')) || defaultHrana;
    let customLijekovi = JSON.parse(localStorage.getItem('cL_v14')) || defaultLijekovi;

    function openTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        btn.classList.add('active');
    }

    function renderLists() {
        document.getElementById('hrana_popis').innerHTML = customHrana.map((h, idx) => `
            <div class="entry-item"><div class="item-top"><label class="item-label"><input type="checkbox" class="food-cb" onchange="toggleDetails(this)" data-name="${h}"> <span>${h}</span></label><button class="remove-item-btn" onclick="removeItem('hrana', ${idx})">√ó</button></div>
            <div class="details-selector"><div class="meal-grid">${mealNames.map(m => `<div class="meal-opt" onclick="this.classList.toggle('selected')">${m}</div>`).join('')}</div></div></div>`).join('');
        
        document.getElementById('lijekovi_popis').innerHTML = customLijekovi.map((l, idx) => {
            let extra = l.toUpperCase().includes("OLEOVIT") ? 'Kapi: <input type="number" class="extra-val" style="width:50px;">' : (l.toUpperCase().includes("COLESTYRAMIN") ? 'Grami: <input type="number" class="extra-val" style="width:50px;">' : '');
            return `<div class="entry-item"><div class="item-top"><label class="item-label"><input type="checkbox" class="lijek-cb" onchange="toggleDetails(this)" data-name="${l}"> <span>${l}</span></label><button class="remove-item-btn" onclick="removeItem('lijek', ${idx})">√ó</button></div>
            <div class="details-selector"><div class="extra-input-wrap"><label>Vrijeme: <input type="time" class="lijek-time" value="${document.getElementById('vrijeme_zapisa').value}"></label><div style="margin-top:5px;">${extra}</div></div></div></div>`;
        }).join('');
    }

    function addItem(type) {
        const inputId = type === 'hrana' ? 'novo_hrana' : 'novo_lijek';
        const name = document.getElementById(inputId).value.trim(); if(!name) return;
        if(type === 'hrana') { customHrana.push(name); localStorage.setItem('cH_v14', JSON.stringify(customHrana)); }
        else { customLijekovi.push(name); localStorage.setItem('cL_v14', JSON.stringify(customLijekovi)); }
        document.getElementById(inputId).value = ""; renderLists();
    }

    function removeItem(type, idx) { if(confirm("Ukloniti?")) { if(type === 'hrana') customHrana.splice(idx,1); else customLijekovi.splice(idx,1); localStorage.setItem(type==='hrana'?'cH_v14':'cL_v14', JSON.stringify(type==='hrana'?customHrana:customLijekovi)); renderLists(); } }
    function toggleDetails(cb) { cb.closest('.entry-item').querySelector('.details-selector').classList.toggle('visible', cb.checked); }

    function saveEntry() {
        const entry = {
            id: Date.now(), datum: document.getElementById('datum_zapisa').value, vrijeme: document.getElementById('vrijeme_zapisa').value, stolica: document.getElementById('stolica_stanje').value,
            hrana: Array.from(document.querySelectorAll('.food-cb:checked')).map(cb => ({ name: cb.dataset.name, meals: Array.from(cb.closest('.entry-item').querySelectorAll('.meal-opt.selected')).map(m => m.innerText) })),
            lijekovi: Array.from(document.querySelectorAll('.lijek-cb:checked')).map(cb => { const item = cb.closest('.entry-item'); return { name: cb.dataset.name, time: item.querySelector('.lijek-time').value, extra: item.querySelector('.extra-val') ? item.querySelector('.extra-val').value : '' }; }),
            tlak: document.getElementById('tlak').value, temp: document.getElementById('temp').value, bol: document.getElementById('bol_tip').value, alergija: document.getElementById('alergija_tip').value, napomena: document.getElementById('napomena').value
        };
        let db = JSON.parse(localStorage.getItem('medLog_v14') || "[]"); db.push(entry); localStorage.setItem('medLog_v14', JSON.stringify(db)); alert("Spremljeno!"); location.reload();
    }

    function renderGroupedHistory() {
        const db = JSON.parse(localStorage.getItem('medLog_v14') || "[]");
        const term = document.getElementById('search-input').value.toLowerCase();
        const container = document.getElementById('grouped-history'); container.innerHTML = "";
        const grouped = db.reduce((acc, e) => { if (!acc[e.datum]) acc[e.datum] = []; acc[e.datum].push(e); return acc; }, {});

        Object.keys(grouped).sort((a,b) => new Date(b) - new Date(a)).forEach(date => {
            let mealsMap = { "Doruƒçak":[], "Marenda":[], "Ruƒçak":[], "U≈æina":[], "Veƒçera":[] };
            let drugs = [], probavaRows = [], stanjeRows = [], dayMatch = false;

            grouped[date].forEach(e => {
                let fullText = (e.stolica + " " + (e.napomena||"") + " " + e.tlak + " " + e.temp + " " + e.bol + " " + e.alergija + " " + e.hrana.map(f=>f.name).join(" ") + " " + e.lijekovi.map(l=>l.name).join(" ")).toLowerCase();
                if (fullText.includes(term) || date.includes(term)) dayMatch = true;

                e.hrana.forEach(f => f.meals.forEach(m => mealsMap[m].push(`${f.name} (${e.vrijeme})`)));
                e.lijekovi.forEach(l => drugs.push(`<span class="param-badge">üíä ${l.name} ${l.extra?'['+l.extra+']':''} u ${l.time}</span>`));
                
                if(e.stolica) probavaRows.push(`<div><small>${e.vrijeme}</small>: <b>${e.stolica}</b> <span class="delete-btn" onclick="deleteRecord(${e.id})">bri≈°i</span></div>`);

                if(e.tlak || e.temp || e.bol || e.alergija || e.napomena) {
                    let st = `<div><small>${e.vrijeme}</small>: `;
                    if(e.tlak) st += `<span class="param-badge">Tlak: ${e.tlak}</span>`;
                    if(e.temp) st += `<span class="param-badge">üå°Ô∏è ${e.temp}¬∞C</span>`;
                    if(e.bol) st += `<span class="param-badge">Bol: ${e.bol}</span>`;
                    if(e.alergija) st += `<span class="param-badge" style="color:red">‚ö†Ô∏è ${e.alergija}</span>`;
                    if(e.napomena) st += `<div class="note-box">üìù ${e.napomena}</div>`;
                    st += `<span class="delete-btn" onclick="deleteRecord(${e.id})">bri≈°i</span></div>`;
                    stanjeRows.push(st);
                }
            });

            if (dayMatch) {
                let html = `<div class="day-group"><div class="day-header">${date.split('-').reverse().join('.')} <span class="delete-btn" onclick="deleteDay('${date}')">Obri≈°i dan</span></div>`;
                mealNames.forEach(m => { if(mealsMap[m].length) html += `<div class="meal-row"><span class="meal-title" style="color:var(--success)">${m}</span>${[...new Set(mealsMap[m])].join(', ')}</div>`; });
                if(drugs.length) html += `<div class="meal-row" style="border-left-color:var(--state);"><span class="meal-title" style="color:var(--state)">LIJEKOVI</span>${drugs.join('')}</div>`;
                if(probavaRows.length) html += `<div class="meal-row" style="border-left-color:var(--brown);"><span class="meal-title" style="color:var(--brown)">üí© PROBAVA</span>${probavaRows.join('')}</div>`;
                if(stanjeRows.length) html += `<div class="meal-row" style="border-left-color:var(--danger);"><span class="meal-title" style="color:var(--danger)">üìä STANJE I NAPOMENE</span>${stanjeRows.join('')}</div>`;
                container.innerHTML += html + `</div>`;
            }
        });
    }

    function deleteRecord(id) { if(confirm("Obri≈°i zapis?")) { let db = JSON.parse(localStorage.getItem('medLog_v14') || "[]"); db = db.filter(e => e.id !== id); localStorage.setItem('medLog_v14', JSON.stringify(db)); renderGroupedHistory(); } }
    function deleteDay(date) { if(confirm("Obri≈°i cijeli dan?")) { let db = JSON.parse(localStorage.getItem('medLog_v14') || "[]"); db = db.filter(e => e.datum !== date); localStorage.setItem('medLog_v14', JSON.stringify(db)); renderGroupedHistory(); } }
    
    function exportToCSV() {
        const db = JSON.parse(localStorage.getItem('medLog_v14') || "[]");
        let csv = "\uFEFFDatum,Vrijeme,Hrana,Lijekovi,Stolica,Tlak,Temp,Bol,Alergija,Napomena\n";
        db.forEach(e => { csv += `${e.datum},${e.vrijeme},"${e.hrana.map(f=>f.name).join(";")}", "${e.lijekovi.map(l=>l.name).join(";")}", "${e.stolica}", "${e.tlak}", "${e.temp}", "${e.bol}", "${e.alergija}", "${(e.napomena||"").replace(/"/g, '""')}"\n`; });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `dnevnik_zdravlja.csv`; link.click();
    }

    function importCSV() {
        const fileInput = document.getElementById('csv-file'); if (!fileInput.files.length) return;
        const reader = new FileReader(); reader.onload = function(e) {
            const rows = e.target.result.split('\n').slice(1);
            let db = JSON.parse(localStorage.getItem('medLog_v14') || "[]");
            rows.forEach(row => {
                const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if (cols.length >= 5) {
                    db.push({ id: Date.now() + Math.random(), datum: cols[0].trim(), vrijeme: cols[1].trim(), hrana: cols[2].replace(/"/g, "").split(";").map(x => ({ name: x.trim(), meals: [] })), lijekovi: cols[3].replace(/"/g, "").split(";").map(x => ({ name: x.trim(), time: cols[1], extra: "" })), stolica: cols[4].replace(/"/g, "").trim(), tlak: cols[5]?cols[5].replace(/"/g, ""):"", temp: cols[6]?cols[6].replace(/"/g, ""):"", bol: cols[7]?cols[7].replace(/"/g, ""):"", alergija: cols[8]?cols[8].replace(/"/g, ""):"", napomena: cols[9]?cols[9].replace(/"/g, ""):"" });
                }
            });
            localStorage.setItem('medLog_v14', JSON.stringify(db)); alert("Podaci uvezeni!"); location.reload();
        };
        reader.readAsText(fileInput.files[0]);
    }

    document.getElementById('datum_zapisa').valueAsDate = new Date();
    document.getElementById('vrijeme_zapisa').value = new Date().toTimeString().slice(0,5);
    renderLists();
</script>
</body>
</html>
